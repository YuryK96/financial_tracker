name: Prod server deploy
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Deploy app
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          script: |
            set -e
            cd financial_tracker
            git checkout main
            git pull origin main
            
            cat > .env <<'EOF'
            DOMAIN=${{ vars.DOMAIN }}
            ACME_EMAIL=${{ vars.ACME_EMAIL }}
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            EOF
            
            mkdir -p traefik
            touch traefik/acme.json
            chmod 600 traefik/acme.json
            
            docker network create web 2>/dev/null || true
  
            docker-compose stop || true
            sleep 3
            docker-compose rm -f || true
            docker image prune -af --filter "until=24h" 2>/dev/null || true
            
            docker volume prune -f 2>/dev/null || true
            docker-compose build --pull --no-cache
            docker-compose up -d
            sleep 15
            docker-compose ps

            
